name: CI build → push → trigger deploy
on:
  push:
    branches: [ main ]

jobs:
  build-and-trigger:
    runs-on: ubuntu-latest
    env:
      IMAGE_REG: registry.bitofbytes.io
      IMAGE_NAME: bob
    steps:
      - uses: actions/checkout@v4

      - name: Derive TAG
        id: meta
        run: echo "TAG=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REG }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # Build & push using your Makefile (single source of truth)
      # Adjust var names if your Makefile expects different ones.
      - name: make build (push)
        run: |
          make build REGISTRY="${IMAGE_REG}" IMAGE="${IMAGE_NAME}" TAG="${{ steps.meta.outputs.TAG }}" PUSH=1

      # Push code to your on-prem bare repo to trigger the post-receive hook
      - name: Install SSH key & known_hosts
        env:
          DEPLOY_KEY: ${{ secrets.LOCAL_REPO_DEPLOY_KEY }}
          KNOWN_HOSTS: ${{ secrets.LOCAL_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "$KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Push main to local bare repo (trigger hook)
        env:
          MANAGER: manager.bitofbytes.io   # change to your Swarm manager DNS/IP
        run: |
          set -euo pipefail
          git remote add local "ssh://git@${MANAGER}/srv/git/bob-ci.git"
          git push --force local HEAD:refs/heads/main
